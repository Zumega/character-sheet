var jQ=jQuery,sheet={settings:{saveUrl:"./includes/save.php",newSkillUrl:"./includes/single_skill.php",newCompAssetUrl:"./includes/single_comp_asset.php",queueTimer:null},data:{defaultPoints:{},characterInfo:{},attributes:{},derivedTraits:{},rolledTraits:{},skills:{},allskills:{animal_handaling:Array("Animal Training","Riding","Veterinary","Zoology"),medical_expertise:Array("dentistry","forensics","general practice","genetics","internal medicine","neurology","pharmaceuticals","physiology","psychiatry","rehabilitation","surgery","toxicology","veterinary medicine"),artistry:Array("Appraisal","Cooking","Forgery","Game Design","Painting","Photography","Poetry","Sculpting","Writing"),perception:Array("deduction","empathy","gambling","hearing","intuition","investigation","read lips","search","sight","smell","tactics","taste","tracking"),covert:Array("camouflage","disable devices","forgery","infiltration","open locks","sabotage","sleight of hand","stealth","streetwise","surveillance"),performance:Array("acting","dancing","costuming","keyboard instruments","impersonation","mimicry","oratory","percussion instruments","singing","stringed instruments","wind instruments"),craft:Array("architecture","blacksmithing","carpentry","cooking","leather working","metalworking","pottery","sewing"),pilot:Array("aerial navigation","astrogation","astronomy","astrophysics","space survival","gunships","hang glinders","helicopters","large cruisers","mid-bulk transports","patrol vessels","rocket shuttles","ultra-light aircraft","short range shuttles"),discipline:Array("concentration","interrogation","intimidation","leadership","mental resistance","morale"),planetary_vehicles:Array("aquatic navigation","cars","canoes","equestrian","ground vehicle repair","horse-drawn conveyances","hovercraft","industrial vehicles","land navigation","large ground transports","military combat vehicles","powerboats","sailing","scooters","scuba diving","skiffs","submarines","yachts"),guns:Array("assault rifles","energy weapons","grenade launchers","gunsmithing","machine guns","pistols","rifles","shotguns"),ranged_weapons:Array("Blowguns","bows","crossbows","darts","grenade","javelin","ranged weaponsmithing","slings","throwing axes","throwing knives"),heavy_weapons:Array("artillery","catapults","demolitions","forward observer","mounted guns","repair heavy weapons","rocket launchers","ship's cannons","siege weapons"),scientific_expertise:Array("earth sciences","historical sciences","life sciences","mathematical sciences"),influence:Array("administration","barter","bureaucracy","conversation","counseling","interrogation","intimidation","leadership","marketing","persuasion","politics","seduction","streetwise"),survival:Array("aerial survival","aquatic survival","general navigation","land survival","nature","space survival","specific environment survival","specific condition survival","tracking","trapping"),knowledge:Array("appraisal","cultures","history","law","literature","philosophy","religion","sports"),technical_eng:Array("Communication systems","computer programming","hacking","create/alter technical devices","demolitions","electronics","technical repair","technical security systems"),mechanical_eng:Array("create mechanical devices","machinery maintenance","mechanical repairs","fix mechanical security systems","plumbing"),unarmed_combat:Array("boxing","brawling","judo","karate","kung fu","savate","wrestling"),linguist:Array("Arabic","Armenian","French","German","Hindu","Japanese","Latin","Portuguese","Russian","Tagalog","Swahili","Swedish"),athletics:Array("climbing","contortion","dodge","juggling","jumping","gymnastics","parachuting","parasailing","pole vaulting","riding","running","swimming","weight lifting"),melee_weapons:Array("clubs","knives","melee weaponsmithing","nunchaku","pole arms","swords","whips")},usedSkills:new Array,usedSubSkills:new Array,equipment:{},allItems:"",equipResize:"+=300",comp:{},asset:{},allCompAsset:{comp:Array("========","Allergy","Amorous","Amputee","Bleeder","Blind","Branded","Chip on the Shoulder","Credo","Combat Paralysis","Coward","Crude","Dead Broke","Deadly Enemy","Deaf","Dull Sense","Easy mark","Ego Signature","Filcher","Forked Tongue","Greedy","Hero Worship","Hooked","Leaky Brainpan","Lightweight","Little Person","Loyal","Memorable","Mute","Non-Fightin' Type","Overconfident","Paralyzed","Phobia","Portly","Prejudice","Sadistic","Scrawny","Slow Learner","Soft","Stingy","Straight Shooter","Superstitious","Things Don't Go Smooth","Traumatic Flashes","Twitchy","Ugly as Sin","Weak Stomach"),asset:Array("========","Allure","Athlete","Born Behind the Wheel","Cortex Specter","Fightin' Type","Friends in High Places","Friends in low Places","Good Name","Healthy as a Horse","Heavy Tolerance","Highly Educated","Intimidatin' Manner","Leadership","Lightnin' Reflexes","Math Whiz","Mean Left Hook","Mechanical Empathy","Military Rank","Moneyed Individual","Natural Linguist","Nature Lover","Nose for Trouble","Reader","Registered Companion","Religiosity","Sharp Sense","Steady Calm","Sweet and Cheerful","Talented","Things Go Smooth","Total Recall","Tough as Nails","Trustworthy Gut","Two-Fisted","Walking Timepiece","Wears a Badge")},usedComp:new Array,usedAsset:new Array,dice:{},displayDice:new Array,usedDice:new Array,hasChanged:false,lastActiveArea:null,saveArea:""},functions:{init:function(){sheet.functions.setObjects();sheet.functions.getDefalutPoints();sheet.functions.getCharacterInfo();sheet.functions.getAttributes();sheet.functions.getDerivedTraits();sheet.functions.getRolledTraits();sheet.functions.getSkills();sheet.functions.getEquipment();sheet.functions.getComplications();sheet.functions.getAssets();sheet.functions.getDice();sheet.data.hasChanged=false;sheet.functions.setStunWoundClicks();sheet.functions.ouchCheck();sheet.functions.setDerivedTraits();sheet.functions.skillCountChanger();sheet.functions.skillUpdater();sheet.functions.subSkillUpdater();sheet.functions.setEquipmentTabs();sheet.functions.setEquipmentResizer();sheet.functions.compCountChanger();sheet.functions.compUpdater();sheet.functions.assetCountChanger();sheet.functions.assetUpdater();sheet.functions.setDiceClicks();sheet.functions.getChanges();sheet.functions.showHideModules();sheet.functions.controlsNumbers()},setObjects:function(){sheet.settings.saveObj=jQ("#saveMessage");sheet.settings.woundBarObj=jQ("#woundPointBar");sheet.settings.stunBarObj=jQ("#stunPointBar");sheet.settings.woundCounterBarObj=jQ("#woundCounterBar");sheet.settings.stunCounterBarObj=jQ("#stunCounterBar");sheet.settings.usedAttrPointsObj=jQ("#usedAttrPoints");sheet.settings.usedSkillPointsObj=jQ("#usedSkillPoints")},getDefalutPoints:function(){sheet.data.defaultPoints.maxLifePoints=parseInt(jQ("#maxLifePoints").val());sheet.data.defaultPoints.maxAttrPoints=parseInt(jQ("#attrPoints").val());sheet.data.defaultPoints.usedAttrPoints=parseInt(jQ("#usedAttrPoints").val());sheet.data.defaultPoints.maxSkillPoints=parseInt(jQ("#skillPoints").val());sheet.data.defaultPoints.usedSkillPoints=parseInt(jQ("#usedSkillPoints").val())},getCharacterInfo:function(){if(sheet.data.characterInfo.name!==jQ("#charName").val()||sheet.data.characterInfo.nickname!==jQ("#nickName").val()||sheet.data.characterInfo.playerName!==jQ("#playerName").val()||sheet.data.characterInfo.homeWorld!==jQ("#homeWorld").val()||sheet.data.characterInfo.concept!==jQ("#concept").val()||sheet.data.characterInfo.plotPoints!==parseInt(jQ("#plot").val())||sheet.data.characterInfo.woundPoints!==parseInt(jQ("#woundPoints").val())||sheet.data.characterInfo.stunPoints!==parseInt(jQ("#stunPoints").val())){sheet.data.hasChanged=true}sheet.data.characterInfo.name=jQ("#charName").val();sheet.data.characterInfo.nickname=jQ("#nickName").val();sheet.data.characterInfo.playerName=jQ("#playerName").val();sheet.data.characterInfo.homeWorld=jQ("#homeWorld").val();sheet.data.characterInfo.concept=jQ("#concept").val();sheet.data.characterInfo.plotPoints=parseInt(jQ("#plot").val());sheet.data.characterInfo.woundPoints=parseInt(jQ("#woundPoints").val());sheet.data.characterInfo.stunPoints=parseInt(jQ("#stunPoints").val());return sheet.data.hasChanged},getAttributes:function(){if(sheet.data.attributes.strength!==parseInt(jQ("#str").val())||sheet.data.attributes.agility!==parseInt(jQ("#agl").val())||sheet.data.attributes.vitality!==parseInt(jQ("#vit").val())||sheet.data.attributes.alertness!==parseInt(jQ("#alert").val())||sheet.data.attributes.intelligence!==parseInt(jQ("#intl").val())||sheet.data.attributes.willpower!==parseInt(jQ("#willpower").val())){sheet.data.hasChanged=true}sheet.data.attributes.strength=parseInt(jQ("#str").val());sheet.data.attributes.agility=parseInt(jQ("#agl").val());sheet.data.attributes.vitality=parseInt(jQ("#vit").val());sheet.data.attributes.alertness=parseInt(jQ("#alert").val());sheet.data.attributes.intelligence=parseInt(jQ("#intl").val());sheet.data.attributes.willpower=parseInt(jQ("#willpower").val());return sheet.data.hasChanged},getDerivedTraits:function(e){var t={d1:parseInt(jQ("#agl").val()),d2:parseInt(jQ("#alert").val()),d3:0,d4:0,initiative:0},n={d1:parseInt(jQ("#vit").val()),d2:parseInt(jQ("#willpower").val()),d3:0,d4:0,lifePoints:0,endurance:0},r=function(e){if(e.d1>12){e.d3=e.d1%12;e.d1=12}if(e.d2>12){e.d4=e.d2%12;e.d2=12}return e};t=r(t);n.lifePoints=n.d1+n.d2;n=r(n);t.initiative="D"+t.d1+" + D"+t.d2;t.initiative+=t.d3!=0?" + D"+t.d3:"";t.initiative+=t.d4!=0?" + D"+t.d4:"";n.endurance="D"+n.d1+" + D"+n.d2;n.endurance+=n.d3!=0?" + D"+n.d3:"";n.endurance+=n.d4!=0?" + D"+n.d4:"";jQ("#int").val(t.initiative);jQ("#lifePoints").val(n.lifePoints);jQ("#endur").val(n.endurance);sheet.data.derivedTraits.initiative=t.initiative;sheet.data.derivedTraits.lifePoints=n.lifePoints;sheet.data.derivedTraits.endurance=n.endurance;if(n.lifePoints>sheet.data.defaultPoints.maxLifePoints){sheet.functions.popup("You have to many life points.<br /><br />You have "+n.lifePoints+"<br /><br />You can only have "+sheet.data.defaultPoints.maxLifePoints);if(typeof e!=="undefined"){e.select();e.focus()}}sheet.functions.ouchCheck()},getRolledTraits:function(){if(sheet.data.rolledTraits.initiative!==jQ("#curntInt").val()||sheet.data.rolledTraits.endurance!==jQ("#curntEndur").val()||sheet.data.rolledTraits.resistance!==jQ("#curntResist").val()){sheet.data.hasChanged=true}sheet.data.rolledTraits.initiative=jQ("#curntInt").val();sheet.data.rolledTraits.endurance=jQ("#curntEndur").val();sheet.data.rolledTraits.resistance=jQ("#curntResist").val();return sheet.data.hasChanged},getSkills:function(){var e=0,t=0;jQ("#skillsContainer").find("select, input").each(function(){var n=jQ(this);if(sheet.data.skills[n.attr("name")]!==n.val()){sheet.data.hasChanged=true}sheet.data.skills[n.attr("name")]=n.val();if(n.attr("name").indexOf("s")===0&&n.val()!=="================="){sheet.data.usedSkills[e]=n.val();e+=1}if(n.attr("name").indexOf("f")===0&&isNaN(n.val())){sheet.data.usedSubSkills[t]=n.val();t+=1}});return sheet.data.hasChanged},getEquipment:function(){jQ(document).find(".equipInput textarea").each(function(){var e=jQ(this);if(e.attr("id")!=="allitems"){if(sheet.data.equipment[e.attr("id")]!==e.val()){sheet.data.hasChanged=true}sheet.data.equipment[e.attr("id")]=e.val()}});jQ(document).find(".equipTab").each(function(){var e=jQ(this);if(e.hasClass("active")){sheet.data.equipment.activeTab=e.children("label").text().toLowerCase().replace(" ","")}});return sheet.data.hasChanged},getComplications:function(){var e=0;jQ("#complicationsFields").find("select, input, textarea").each(function(){var t=jQ(this);if(sheet.data.comp[t.attr("id")]!==t.val()){sheet.data.hasChanged=true}if(t.attr("type")==="radio"){sheet.data.comp[t.attr("id")]=t.is(":checked")?t.val():""}else{if(t.is("select")){sheet.data.usedComp[e]=t.val();e+=1}sheet.data.comp[t.attr("id")]=t.val()}});return sheet.data.hasChanged},getAssets:function(){var e=0;jQ("#assetsFields").find("select, input, textarea").each(function(){var t=jQ(this);if(sheet.data.asset[t.attr("id")]!==t.val()){sheet.data.hasChanged=true}if(t.attr("type")==="radio"){sheet.data.asset[t.attr("id")]=t.is(":checked")?t.val():""}else{if(t.is("select")){sheet.data.usedAsset[e]=t.val();e+=1}sheet.data.asset[t.attr("id")]=t.val()}});return sheet.data.hasChanged},getDice:function(){jQ("#diceDisplay").find("input").each(function(){var e=jQ(this);sheet.data.displayDice[sheet.data.displayDice.length]=e.val();if(e.data("roll").length>0){sheet.data.usedDice[sheet.data.usedDice.length]=e.data("roll")}})},getDiceRoll:function(e){var t=0;while(t>e||t<=0){t=Math.round(Math.random()*e)}sheet.data.usedDice.unshift(parseInt(t));while(sheet.data.usedDice.length>5){sheet.data.usedDice.pop()}return t},getLastRolls:function(){var e={twoDice:sheet.data.usedDice.length>=2?sheet.data.usedDice[0]+sheet.data.usedDice[1]:0,threeDice:sheet.data.usedDice.length>=3?sheet.data.usedDice[0]+sheet.data.usedDice[1]+sheet.data.usedDice[2]:0,fourDice:sheet.data.usedDice.length>=4?sheet.data.usedDice[0]+sheet.data.usedDice[1]+sheet.data.usedDice[2]+sheet.data.usedDice[3]:0,fiveDice:sheet.data.usedDice.length>=5?sheet.data.usedDice[0]+sheet.data.usedDice[1]+sheet.data.usedDice[2]+sheet.data.usedDice[3]+sheet.data.usedDice[4]:0};jQ("#diceNum_2").text(e.twoDice);jQ("#diceNum_3").text(e.threeDice);jQ("#diceNum_4").text(e.fourDice);jQ("#diceNum_5").text(e.fiveDice)},setStunWoundClicks:function(){jQ(document).find(".characterInfo .btnUpDown").click(function(){var e=jQ(this);switch(e.attr("id")){case"woundPointsUp":e.siblings("input[type=text]").val(sheet.data.characterInfo.woundPoints+=1);break;case"woundPointsDown":e.siblings("input[type=text]").val(sheet.data.characterInfo.woundPoints-=1);break;case"stunPointsUp":e.siblings("input[type=text]").val(sheet.data.characterInfo.stunPoints+=1);break;case"stunPointsDown":e.siblings("input[type=text]").val(sheet.data.characterInfo.stunPoints-=1);break}sheet.functions.saveQueue("characterInfo");sheet.functions.ouchCheck()})},ouchCheck:function(){var e=sheet.data.characterInfo.woundPoints+sheet.data.characterInfo.stunPoints,t=100/sheet.data.derivedTraits.lifePoints*sheet.data.characterInfo.woundPoints,n=100/sheet.data.derivedTraits.lifePoints*sheet.data.characterInfo.stunPoints,r=100/sheet.data.derivedTraits.lifePoints*e/100,i=100-t,s=100-n;sheet.settings.woundBarObj.animate({width:t+"%"}).css("backgroundColor","rgba(255,0,0,"+r+")");sheet.settings.stunBarObj.animate({width:n+"%"}).css("backgroundColor","rgba(255,0,255,"+r+")");sheet.settings.woundCounterBarObj.animate({width:i+"%"});sheet.settings.stunCounterBarObj.animate({width:s+"%"});if(sheet.data.characterInfo.woundPoints>0){jQ("#woundPointsDown").removeClass("hide")}if(sheet.data.characterInfo.woundPoints===0){jQ("#woundPointsDown").addClass("hide")}if(sheet.data.characterInfo.stunPoints>0){jQ("#stunPointsDown").removeClass("hide")}if(sheet.data.characterInfo.stunPoints===0){jQ("#stunPointsDown").addClass("hide")}if(sheet.data.characterInfo.woundPoints+sheet.data.characterInfo.stunPoints>=sheet.data.derivedTraits.lifePoints){jQ("#woundPointsUp, #stunPointsUp").addClass("hide")}if(sheet.data.characterInfo.woundPoints+sheet.data.characterInfo.stunPoints<sheet.data.derivedTraits.lifePoints){jQ("#woundPointsUp, #stunPointsUp").removeClass("hide")}sheet.functions.deathCheck()},deathCheck:function(){if(sheet.data.derivedTraits.lifePoints<=sheet.data.characterInfo.woundPoints+sheet.data.characterInfo.stunPoints){sheet.functions.popup("You DEAD!!","dead")}},setDerivedTraits:function(){jQ("#agl, #alert, #vit, #willpower").blur(function(){sheet.functions.getDerivedTraits(jQ(this))})},skillCountChanger:function(){jQ(document).find(".skillsSpecialties .btnUpDown").click(function(){var e=jQ(this),t=jQ("#SkillsCnt"),n=parseInt(t.text());switch(e.attr("id")){case"skillUp":jQ.ajax({url:sheet.settings.newSkillUrl,type:"POST",data:{data:n,used:sheet.data.usedSkills},dataType:"html",success:function(e){jQ("#skillsContainer").append(e).find(".column:last-child").slideDown("fast");if(sheet.functions.getSkills()){sheet.data.hasChanged=false;sheet.functions.saveQueue("skills")}},error:function(e,t,n){sheet.functions.ajaxError(n)}});n+=1;t.text(n);if(n>0){jQ("#skillDown").removeClass("hide")}break;case"skillDown":jQ("#skillsContainer").find(".column:last-child").slideUp("fast",function(){jQ(this).remove();n-=1;sheet.data.usedSkills.pop();delete sheet.data.skills["skill_"+n];delete sheet.data.skills["field_"+n+"_0"];delete sheet.data.skills["field_"+n+"_1"];delete sheet.data.skills["field_"+n+"_2"];delete sheet.data.skills["field_"+n+"_3"];delete sheet.data.skills["field_"+n+"_4"];delete sheet.data.skills["field_"+n+"_5"];delete sheet.data.skills["field_"+n+"_6"];if(n>0){jQ("#skillsContainer").find("input:first-child").trigger("blur")}sheet.functions.getSkills();sheet.functions.saveQueue("skills");t.text(n);if(n===0){jQ("#skillDown").addClass("hide")}});break}})},skillUpdater:function(){jQ("#skillsContainer").on("change",".skilColum_1 select",function(){var e=jQ(this),t=e.attr("id"),n=e.val(),r={};n=n.replace(/[ ]/gi,"_");n=n.replace(/\.|\*/gi,"");if(sheet.functions.getSkills()){for(skills in sheet.data.allskills){if(n===skills){for(var i=0;i<sheet.data.allskills[skills].length;i+=1){var s=sheet.data.allskills[skills];for(var o=0;o<s.length;o+=1){r[s[o].toLowerCase()]=s[o]}}}}jQ("#"+t+"_1 option:gt(0)").remove();jQ("#"+t+"_2 option:gt(0)").remove();jQ("#"+t+"_3 option:gt(0)").remove();jQ.each(r,function(e,n){jQ("#"+t+"_1").append(jQ("<option></option>").attr("value",e).text(n));jQ("#"+t+"_2").append(jQ("<option></option>").attr("value",e).text(n));jQ("#"+t+"_3").append(jQ("<option></option>").attr("value",e).text(n))});jQ("#skillsContainer").find(".skilColum_1 option").each(function(){jQ(this).removeAttr("disabled");for(var e in sheet.data.usedSkills){if(sheet.data.usedSkills[e]===jQ(this).val()){jQ(this).attr("disabled","disabled")}}});sheet.functions.getSpecialChanges.skill()}})},subSkillUpdater:function(){jQ("#skillsContainer").on("change",".skilColum_2 select",function(){var e=jQ(this),t=jQ("#skillsContainer .skilColum_2 option"),n=0;sheet.data.usedSubSkills=[];jQ("#skillsContainer").find(".skilColum_2 select").each(function(){var e=jQ(this);if(e.attr("name").indexOf("f")===0&&isNaN(e.val())){sheet.data.usedSubSkills[n]=e.val();n+=1}});t.each(function(){jQ(this).removeAttr("disabled")});t.each(function(){for(var e in sheet.data.usedSubSkills){if(sheet.data.usedSubSkills[e]===jQ(this).val()){jQ(this).attr("disabled","disabled")}}});sheet.functions.getSpecialChanges.skill()})},setEquipmentTabs:function(){jQ(document).find(".equipTab").click(function(){var e=jQ(this),t=e.children("label").attr("for");jQ(document).find(".equipTab").each(function(){if(jQ(this).hasClass("active")){jQ(this).removeClass("active")}});e.addClass("active");sheet.data.equipment.activeTab=t;sheet.functions.setEquipmentFields(t);sheet.data.hasChanged=false;sheet.functions.saveQueue("equipment")})},setEquipmentResizer:function(){jQ(document).find(".expandContract").click(function(){jQ(this).toggleClass("active");jQ(document).find(".equipInput textarea").each(function(){jQ(this).animate({height:sheet.data.equipResize},500)});sheet.data.equipResize=sheet.data.equipResize==="+=300"?"-=300":"+=300"})},setEquipmentFields:function(e){jQ(document).find(".equipInput textarea").each(function(){var t=jQ(this);if(t.hasClass("active")){t.removeClass("active")}if(t.attr("id")===e){t.addClass("active")}})},updateAllItemsField:function(){var e={};jQ(document).find(".equipInput textarea").each(function(){e[jQ(this).attr("id")]=jQ(this).val()});delete e.allitems;delete e.notes;sheet.data.allItems="";for(var t in e){sheet.data.allItems+=t.charAt(0).toUpperCase()+t.slice(1)+":\n"+e[t]+"\n\n\n"}jQ("#allitems").val(sheet.data.allItems)},compCountChanger:function(){jQ("#complicationsUp, #complicationsDown").on("click",function(){var e=jQ(this),t=jQ("#complicationsCnt"),n=parseInt(t.text());switch(e.attr("id")){case"complicationsUp":jQ.ajax({url:sheet.settings.newCompAssetUrl,type:"POST",data:{count:n,type:"complications",used:sheet.data.usedComp},dataType:"html",success:function(e){jQ("#complicationsFields").append(e).find(".section:last-child").slideDown("fast");if(sheet.functions.getComplications()){sheet.data.hasChanged=false;sheet.functions.saveQueue("comp")}},error:function(e,t,n){sheet.functions.ajaxError(n)}});n+=1;t.text(n);if(n>0){jQ("#complicationsDown").removeClass("hide")}break;case"complicationsDown":jQ("#complicationsFields").find(".section:last-child").slideUp("fast",function(){jQ(this).remove();n-=1;sheet.data.usedComp.pop();delete sheet.data.comp["desc_"+n+"_complications"];delete sheet.data.comp["maj_"+n+"_complications"];delete sheet.data.comp["min_"+n+"_complications"];delete sheet.data.comp["typeName_"+n+"_complications"];sheet.functions.getComplications();sheet.functions.saveQueue("comp");t.text(n);if(n===0){e.addClass("hide")}});break}})},compUpdater:function(){jQ("#complicationsFields").on("change","select, input",function(){sheet.functions.getSpecialChanges.comp()});jQ("#complicationsFields").on("focus","textarea",function(){var e=jQ(this);if(e.val()==="(NOTES)"){e.removeClass("new").val("")}});jQ("#complicationsFields").on("blur","textarea",function(){var e=jQ(this);if(e.val()===""){e.addClass("new").val("(NOTES)")}sheet.functions.getSpecialChanges.comp()});jQ("#complicationsFields").on("change","select",function(){jQ("#complicationsFields").find("option").each(function(){jQ(this).removeAttr("disabled");for(var e in sheet.data.usedComp){if(sheet.data.usedComp[e]===jQ(this).val()){jQ(this).attr("disabled","disabled")}}})})},assetCountChanger:function(){jQ("#assetsUp, #assetsDown").on("click",function(){var e=jQ(this),t=jQ("#assetsCnt"),n=parseInt(t.text());switch(e.attr("id")){case"assetsUp":jQ.ajax({url:sheet.settings.newCompAssetUrl,type:"POST",data:{count:n,type:"assets",used:sheet.data.usedAsset},dataType:"html",success:function(e){jQ("#assetsFields").append(e).find(".section:last-child").slideDown("fast");if(sheet.functions.getAssets()){sheet.data.hasChanged=false;sheet.functions.saveQueue("asset")}},error:function(e,t,n){sheet.functions.ajaxError(n)}});n+=1;t.text(n);if(n>0){jQ("#assetsDown").removeClass("hide")}break;case"assetsDown":jQ("#assetsFields").find(".section:last-child").slideUp("fast",function(){jQ(this).remove();n-=1;sheet.data.usedAsset.pop();delete sheet.data.asset["desc_"+n+"_assets"];delete sheet.data.asset["maj_"+n+"_assets"];delete sheet.data.asset["min_"+n+"_assets"];delete sheet.data.asset["typeName_"+n+"_assets"];sheet.functions.getAssets();sheet.functions.saveQueue("asset");t.text(n);if(n===0){e.addClass("hide")}});break}})},assetUpdater:function(){jQ("#assetsFields").on("change","select, input",function(){sheet.functions.getSpecialChanges.asset()});jQ("#assetsFields").on("focus","textarea",function(){var e=jQ(this);if(e.val()==="(NOTES)"){e.removeClass("new").val("")}});jQ("#assetsFields").on("blur","textarea",function(){var e=jQ(this);if(e.val()===""){e.addClass("new").val("(NOTES)")}sheet.functions.getSpecialChanges.asset()});jQ("#assetsFields").on("change","select",function(){jQ("#assetsFields").find("option").each(function(){jQ(this).removeAttr("disabled");for(var e in sheet.data.usedAsset){if(sheet.data.usedAsset[e]!=="========"&&sheet.data.usedAsset[e]===jQ(this).val()){jQ(this).attr("disabled","disabled")}}})})},checkInputs:{generic:function(e,t,n){var r=0;if(e.val()===""){e.val(0)}if(e.val()%2||isNaN(e.val())){sheet.functions.popup("The number needs to corispond to a dice number<br /><br />Meaning it needs to be even.");if(typeof e!=="undefined"){e.select();e.focus()}return false}t.each(function(){r+=parseInt(jQ(this).val())});sheet.data.defaultPoints["used"+n+"Points"]=r;sheet.settings["used"+n+"PointsObj"].val(r);if(r>sheet.data.defaultPoints["max"+n+"Points"]){sheet.functions.popup("You have use to many points<br /><br />You only have "+sheet.data.defaultPoints["max"+n+"Points"]+" points to use.<br /><br />And you have used "+r+" so far.");if(typeof e!=="undefined"){e.select();e.focus()}return false}}},setDiceClicks:function(){jQ(document).find(".diceUI li span").click(function(){var e=jQ(this);if(e.data("dice")===0){sheet.data.usedDice=[];sheet.data.dice={};for(var t in sheet.data.displayDice){jQ("#dice_"+t).addClass("hide").val("").data("roll","")}sheet.data.displayDice=[]}else{var n=sheet.functions.getDiceRoll(e.data("dice"));sheet.data.displayDice.unshift("D"+e.data("dice")+" = "+n);while(sheet.data.displayDice.length>14){sheet.data.displayDice.pop()}for(var t in sheet.data.displayDice){var r=jQ("#dice_"+t);sheet.data.dice["dice_"+t]=sheet.data.displayDice[t];r.val(sheet.data.displayDice[t]);if(sheet.data.displayDice[t].length>0&&r.hasClass("hide")){r.removeClass("hide")}}}sheet.functions.getLastRolls();sheet.functions.saveQueue("dice")})},getChanges:function(){jQ(document).find(".characterInfo input[type=text]").blur(function(){if(sheet.functions.getCharacterInfo()){sheet.data.hasChanged=false;sheet.functions.ouchCheck();sheet.functions.save("characterInfo")}});jQ(document).find(".attributes input[type=text]").blur(function(){if(sheet.functions.getAttributes()){sheet.data.hasChanged=false;sheet.functions.save("attributes")}});jQ(document).find(".attributes input[type!=hidden]").blur(function(){sheet.functions.checkInputs.generic(jQ(this),jQ(document).find(".attributes input"),"Attr")});jQ("#skillsContainer").on("blur","input",function(){sheet.functions.checkInputs.generic(jQ(this),jQ("#skillsContainer").find("input"),"Skill")});jQ("#curntInt, #curntEndur, #curntResist").blur(function(){if(sheet.functions.getRolledTraits()){sheet.data.hasChanged=false;sheet.functions.save("rolledTraits")}});jQ("#skillsContainer").on("blur","input[type=text]",function(){if(sheet.functions.getSkills()){sheet.data.hasChanged=false;sheet.functions.save("skills")}});jQ(document).find(".equipInput textarea").blur(function(){if(jQ(this).attr("id")!=="allitems"){sheet.functions.updateAllItemsField();if(sheet.functions.getEquipment()){sheet.data.hasChanged=false;sheet.functions.save("equipment")}}});jQ(document).find(".diceUI span").click(function(){if(sheet.functions.getDice()){sheet.data.hasChanged=false}})},getSpecialChanges:{skill:function(){if(sheet.functions.getSkills()){sheet.data.hasChanged=false;sheet.functions.save("skills")}},comp:function(){if(sheet.functions.getComplications()){sheet.data.hasChanged=false;sheet.functions.save("comp")}},asset:function(){if(sheet.functions.getAssets()){sheet.data.hasChanged=false;sheet.functions.save("asset")}}},saveQueue:function(e){if(sheet.settings.queueTimer===null){sheet.data.saveArea=e;sheet.settings.queueTimer=setTimeout("sheet.functions.save(); sheet.settings.queueTimer = null;",3*1e3)}},save:function(e){e=e||sheet.data.saveArea;jQ.ajax({url:sheet.settings.saveUrl,type:"POST",data:{data:{content:JSON.stringify(sheet.data[e]),saveArea:e}},dataType:"jsonp",jsonpCallback:e+"_callback",success:function(e){if(e.status!=="done"){sheet.settings.saveObj.text(e.status)}else{sheet.settings.saveObj.text("Saved")}sheet.settings.saveObj.animate({top:"+=50"},500).delay(1e3).animate({top:"-=50"},500)},error:function(e,t,n){sheet.functions.ajaxError(n)}})},ajaxError:function(e){var t="<div class='ajaxError'>"+e+"</div>";jQ("body").append(t)},showHideModules:function(){jQ(document).find(".close").on("click",function(){var e=jQ(document).find("."+jQ(this).parent().attr("id"));jQ(this).toggleClass("active");if(e.css("display")==="none"){e.slideDown()}else{e.slideUp()}})},controlsNumbers:function(){jQ("#controlsContainer").click(function(){jQ(this).animate({top:"-300px"},700,function(){jQ("#controlTab").animate({top:"0px"},100)})});jQ("#controlTab").click(function(){jQ(this).animate({top:"-30px"},100,function(){jQ("#controlsContainer").animate({top:"0px"},700)})});jQ("#controlsContainer").delay(5e3).trigger("click")},popup:function(e,t){t=t||"";if(jQ("#bgOverlay").length===0){var n='<div id="bgOverlay" class="bgOverlay"></div>'+'<div id="popUp" class="popUp"></div>';jQ("body").append(n)}switch(t){case"dead":jQ("#bgOverlay").addClass("deathOverlay");break;default:jQ("#bgOverlay").removeClass("deathOverlay")}jQ("#bgOverlay, #popUp").show();jQ("#popUp").html(e).css({top:"20%",left:jQ(window).width()/2-jQ("#popUp").width()/2+"px"});jQ("#bgOverlay").on("click",function(){jQ("#bgOverlay, #popUp").hide()});jQ(document).keyup(function(e){if(e.keyCode===27||e.keyCode===13){jQ("#bgOverlay, #popUp").hide()}})},unLoad:function(){sheet.functions.getCharacterInfo();sheet.functions.getAttributes();sheet.functions.getDerivedTraits();sheet.functions.getRolledTraits();sheet.functions.getSkills();sheet.functions.getEquipment();sheet.functions.getComplications();sheet.functions.getAssets();sheet.functions.getDice();jQ.ajax({url:sheet.settings.saveUrl,type:"POST",data:{data:{content:JSON.stringify(sheet.data),saveArea:"all"}},async:false})},signOut:function(){jQ(document).find(".signOut").click(function(e){e.preventBubble();window.location=jQ(this).attr("href")})}}};jQ(document).ready(function(){sheet.functions.init()});jQ(window).unload(function(){});var jQ=jQuery,sheet={settings:{saveUrl:"./includes/save.php",newSkillUrl:"./includes/single_skill.php",newCompAssetUrl:"./includes/single_comp_asset.php",queueTimer:null},data:{defaultPoints:{},characterInfo:{},attributes:{},derivedTraits:{},rolledTraits:{},skills:{},allskills:{animal_handaling:Array("Animal Training","Riding","Veterinary","Zoology"),medical_expertise:Array("dentistry","forensics","general practice","genetics","internal medicine","neurology","pharmaceuticals","physiology","psychiatry","rehabilitation","surgery","toxicology","veterinary medicine"),artistry:Array("Appraisal","Cooking","Forgery","Game Design","Painting","Photography","Poetry","Sculpting","Writing"),perception:Array("deduction","empathy","gambling","hearing","intuition","investigation","read lips","search","sight","smell","tactics","taste","tracking"),covert:Array("camouflage","disable devices","forgery","infiltration","open locks","sabotage","sleight of hand","stealth","streetwise","surveillance"),performance:Array("acting","dancing","costuming","keyboard instruments","impersonation","mimicry","oratory","percussion instruments","singing","stringed instruments","wind instruments"),craft:Array("architecture","blacksmithing","carpentry","cooking","leather working","metalworking","pottery","sewing"),pilot:Array("aerial navigation","astrogation","astronomy","astrophysics","space survival","gunships","hang glinders","helicopters","large cruisers","mid-bulk transports","patrol vessels","rocket shuttles","ultra-light aircraft","short range shuttles"),discipline:Array("concentration","interrogation","intimidation","leadership","mental resistance","morale"),planetary_vehicles:Array("aquatic navigation","cars","canoes","equestrian","ground vehicle repair","horse-drawn conveyances","hovercraft","industrial vehicles","land navigation","large ground transports","military combat vehicles","powerboats","sailing","scooters","scuba diving","skiffs","submarines","yachts"),guns:Array("assault rifles","energy weapons","grenade launchers","gunsmithing","machine guns","pistols","rifles","shotguns"),ranged_weapons:Array("Blowguns","bows","crossbows","darts","grenade","javelin","ranged weaponsmithing","slings","throwing axes","throwing knives"),heavy_weapons:Array("artillery","catapults","demolitions","forward observer","mounted guns","repair heavy weapons","rocket launchers","ship's cannons","siege weapons"),scientific_expertise:Array("earth sciences","historical sciences","life sciences","mathematical sciences"),influence:Array("administration","barter","bureaucracy","conversation","counseling","interrogation","intimidation","leadership","marketing","persuasion","politics","seduction","streetwise"),survival:Array("aerial survival","aquatic survival","general navigation","land survival","nature","space survival","specific environment survival","specific condition survival","tracking","trapping"),knowledge:Array("appraisal","cultures","history","law","literature","philosophy","religion","sports"),technical_eng:Array("Communication systems","computer programming","hacking","create/alter technical devices","demolitions","electronics","technical repair","technical security systems"),mechanical_eng:Array("create mechanical devices","machinery maintenance","mechanical repairs","fix mechanical security systems","plumbing"),unarmed_combat:Array("boxing","brawling","judo","karate","kung fu","savate","wrestling"),linguist:Array("Arabic","Armenian","French","German","Hindu","Japanese","Latin","Portuguese","Russian","Tagalog","Swahili","Swedish"),athletics:Array("climbing","contortion","dodge","juggling","jumping","gymnastics","parachuting","parasailing","pole vaulting","riding","running","swimming","weight lifting"),melee_weapons:Array("clubs","knives","melee weaponsmithing","nunchaku","pole arms","swords","whips")},usedSkills:new Array,usedSubSkills:new Array,equipment:{},allItems:"",equipResize:"+=300",comp:{},asset:{},allCompAsset:{comp:Array("========","Allergy","Amorous","Amputee","Bleeder","Blind","Branded","Chip on the Shoulder","Credo","Combat Paralysis","Coward","Crude","Dead Broke","Deadly Enemy","Deaf","Dull Sense","Easy mark","Ego Signature","Filcher","Forked Tongue","Greedy","Hero Worship","Hooked","Leaky Brainpan","Lightweight","Little Person","Loyal","Memorable","Mute","Non-Fightin' Type","Overconfident","Paralyzed","Phobia","Portly","Prejudice","Sadistic","Scrawny","Slow Learner","Soft","Stingy","Straight Shooter","Superstitious","Things Don't Go Smooth","Traumatic Flashes","Twitchy","Ugly as Sin","Weak Stomach"),asset:Array("========","Allure","Athlete","Born Behind the Wheel","Cortex Specter","Fightin' Type","Friends in High Places","Friends in low Places","Good Name","Healthy as a Horse","Heavy Tolerance","Highly Educated","Intimidatin' Manner","Leadership","Lightnin' Reflexes","Math Whiz","Mean Left Hook","Mechanical Empathy","Military Rank","Moneyed Individual","Natural Linguist","Nature Lover","Nose for Trouble","Reader","Registered Companion","Religiosity","Sharp Sense","Steady Calm","Sweet and Cheerful","Talented","Things Go Smooth","Total Recall","Tough as Nails","Trustworthy Gut","Two-Fisted","Walking Timepiece","Wears a Badge")},usedComp:new Array,usedAsset:new Array,dice:{},displayDice:new Array,usedDice:new Array,hasChanged:false,lastActiveArea:null,saveArea:""},functions:{init:function(){sheet.functions.setObjects();sheet.functions.getDefalutPoints();sheet.functions.getCharacterInfo();sheet.functions.getAttributes();sheet.functions.getDerivedTraits();sheet.functions.getRolledTraits();sheet.functions.getSkills();sheet.functions.getEquipment();sheet.functions.getComplications();sheet.functions.getAssets();sheet.functions.getDice();sheet.data.hasChanged=false;sheet.functions.setStunWoundClicks();sheet.functions.ouchCheck();sheet.functions.setDerivedTraits();sheet.functions.skillCountChanger();sheet.functions.skillUpdater();sheet.functions.subSkillUpdater();sheet.functions.setEquipmentTabs();sheet.functions.setEquipmentResizer();sheet.functions.compCountChanger();sheet.functions.compUpdater();sheet.functions.assetCountChanger();sheet.functions.assetUpdater();sheet.functions.setDiceClicks();sheet.functions.getChanges();sheet.functions.showHideModules();sheet.functions.controlsNumbers()},setObjects:function(){sheet.settings.saveObj=jQ("#saveMessage");sheet.settings.woundBarObj=jQ("#woundPointBar");sheet.settings.stunBarObj=jQ("#stunPointBar");sheet.settings.woundCounterBarObj=jQ("#woundCounterBar");sheet.settings.stunCounterBarObj=jQ("#stunCounterBar");sheet.settings.usedAttrPointsObj=jQ("#usedAttrPoints");sheet.settings.usedSkillPointsObj=jQ("#usedSkillPoints")},getDefalutPoints:function(){sheet.data.defaultPoints.maxLifePoints=parseInt(jQ("#maxLifePoints").val());sheet.data.defaultPoints.maxAttrPoints=parseInt(jQ("#attrPoints").val());sheet.data.defaultPoints.usedAttrPoints=parseInt(jQ("#usedAttrPoints").val());sheet.data.defaultPoints.maxSkillPoints=parseInt(jQ("#skillPoints").val());sheet.data.defaultPoints.usedSkillPoints=parseInt(jQ("#usedSkillPoints").val())},getCharacterInfo:function(){if(sheet.data.characterInfo.name!==jQ("#charName").val()||sheet.data.characterInfo.nickname!==jQ("#nickName").val()||sheet.data.characterInfo.playerName!==jQ("#playerName").val()||sheet.data.characterInfo.homeWorld!==jQ("#homeWorld").val()||sheet.data.characterInfo.concept!==jQ("#concept").val()||sheet.data.characterInfo.plotPoints!==parseInt(jQ("#plot").val())||sheet.data.characterInfo.woundPoints!==parseInt(jQ("#woundPoints").val())||sheet.data.characterInfo.stunPoints!==parseInt(jQ("#stunPoints").val())){sheet.data.hasChanged=true}sheet.data.characterInfo.name=jQ("#charName").val();sheet.data.characterInfo.nickname=jQ("#nickName").val();sheet.data.characterInfo.playerName=jQ("#playerName").val();sheet.data.characterInfo.homeWorld=jQ("#homeWorld").val();sheet.data.characterInfo.concept=jQ("#concept").val();sheet.data.characterInfo.plotPoints=parseInt(jQ("#plot").val());sheet.data.characterInfo.woundPoints=parseInt(jQ("#woundPoints").val());sheet.data.characterInfo.stunPoints=parseInt(jQ("#stunPoints").val());return sheet.data.hasChanged},getAttributes:function(){if(sheet.data.attributes.strength!==parseInt(jQ("#str").val())||sheet.data.attributes.agility!==parseInt(jQ("#agl").val())||sheet.data.attributes.vitality!==parseInt(jQ("#vit").val())||sheet.data.attributes.alertness!==parseInt(jQ("#alert").val())||sheet.data.attributes.intelligence!==parseInt(jQ("#intl").val())||sheet.data.attributes.willpower!==parseInt(jQ("#willpower").val())){sheet.data.hasChanged=true}sheet.data.attributes.strength=parseInt(jQ("#str").val());sheet.data.attributes.agility=parseInt(jQ("#agl").val());sheet.data.attributes.vitality=parseInt(jQ("#vit").val());sheet.data.attributes.alertness=parseInt(jQ("#alert").val());sheet.data.attributes.intelligence=parseInt(jQ("#intl").val());sheet.data.attributes.willpower=parseInt(jQ("#willpower").val());return sheet.data.hasChanged},getDerivedTraits:function(e){var t={d1:parseInt(jQ("#agl").val()),d2:parseInt(jQ("#alert").val()),d3:0,d4:0,initiative:0},n={d1:parseInt(jQ("#vit").val()),d2:parseInt(jQ("#willpower").val()),d3:0,d4:0,lifePoints:0,endurance:0},r=function(e){if(e.d1>12){e.d3=e.d1%12;e.d1=12}if(e.d2>12){e.d4=e.d2%12;e.d2=12}return e};t=r(t);n.lifePoints=n.d1+n.d2;n=r(n);t.initiative="D"+t.d1+" + D"+t.d2;t.initiative+=t.d3!=0?" + D"+t.d3:"";t.initiative+=t.d4!=0?" + D"+t.d4:"";n.endurance="D"+n.d1+" + D"+n.d2;n.endurance+=n.d3!=0?" + D"+n.d3:"";n.endurance+=n.d4!=0?" + D"+n.d4:"";jQ("#int").val(t.initiative);jQ("#lifePoints").val(n.lifePoints);jQ("#endur").val(n.endurance);sheet.data.derivedTraits.initiative=t.initiative;sheet.data.derivedTraits.lifePoints=n.lifePoints;sheet.data.derivedTraits.endurance=n.endurance;if(n.lifePoints>sheet.data.defaultPoints.maxLifePoints){sheet.functions.popup("You have to many life points.<br /><br />You have "+n.lifePoints+"<br /><br />You can only have "+sheet.data.defaultPoints.maxLifePoints);if(typeof e!=="undefined"){e.select();e.focus()}}sheet.functions.ouchCheck()},getRolledTraits:function(){if(sheet.data.rolledTraits.initiative!==jQ("#curntInt").val()||sheet.data.rolledTraits.endurance!==jQ("#curntEndur").val()||sheet.data.rolledTraits.resistance!==jQ("#curntResist").val()){sheet.data.hasChanged=true}sheet.data.rolledTraits.initiative=jQ("#curntInt").val();sheet.data.rolledTraits.endurance=jQ("#curntEndur").val();sheet.data.rolledTraits.resistance=jQ("#curntResist").val();return sheet.data.hasChanged},getSkills:function(){var e=0,t=0;jQ("#skillsContainer").find("select, input").each(function(){var n=jQ(this);if(sheet.data.skills[n.attr("name")]!==n.val()){sheet.data.hasChanged=true}sheet.data.skills[n.attr("name")]=n.val();if(n.attr("name").indexOf("s")===0&&n.val()!=="================="){sheet.data.usedSkills[e]=n.val();e+=1}if(n.attr("name").indexOf("f")===0&&isNaN(n.val())){sheet.data.usedSubSkills[t]=n.val();t+=1}});return sheet.data.hasChanged},getEquipment:function(){jQ(document).find(".equipInput textarea").each(function(){var e=jQ(this);if(e.attr("id")!=="allitems"){if(sheet.data.equipment[e.attr("id")]!==e.val()){sheet.data.hasChanged=true}sheet.data.equipment[e.attr("id")]=e.val()}});jQ(document).find(".equipTab").each(function(){var e=jQ(this);if(e.hasClass("active")){sheet.data.equipment.activeTab=e.children("label").text().toLowerCase().replace(" ","")}});return sheet.data.hasChanged},getComplications:function(){var e=0;jQ("#complicationsFields").find("select, input, textarea").each(function(){var t=jQ(this);if(sheet.data.comp[t.attr("id")]!==t.val()){sheet.data.hasChanged=true}if(t.attr("type")==="radio"){sheet.data.comp[t.attr("id")]=t.is(":checked")?t.val():""}else{if(t.is("select")){sheet.data.usedComp[e]=t.val();e+=1}sheet.data.comp[t.attr("id")]=t.val()}});return sheet.data.hasChanged},getAssets:function(){var e=0;jQ("#assetsFields").find("select, input, textarea").each(function(){var t=jQ(this);if(sheet.data.asset[t.attr("id")]!==t.val()){sheet.data.hasChanged=true}if(t.attr("type")==="radio"){sheet.data.asset[t.attr("id")]=t.is(":checked")?t.val():""}else{if(t.is("select")){sheet.data.usedAsset[e]=t.val();e+=1}sheet.data.asset[t.attr("id")]=t.val()}});return sheet.data.hasChanged},getDice:function(){jQ("#diceDisplay").find("input").each(function(){var e=jQ(this);sheet.data.displayDice[sheet.data.displayDice.length]=e.val();if(e.data("roll").length>0){sheet.data.usedDice[sheet.data.usedDice.length]=e.data("roll")}})},getDiceRoll:function(e){var t=0;while(t>e||t<=0){t=Math.round(Math.random()*e)}sheet.data.usedDice.unshift(parseInt(t));while(sheet.data.usedDice.length>5){sheet.data.usedDice.pop()}return t},getLastRolls:function(){var e={twoDice:sheet.data.usedDice.length>=2?sheet.data.usedDice[0]+sheet.data.usedDice[1]:0,threeDice:sheet.data.usedDice.length>=3?sheet.data.usedDice[0]+sheet.data.usedDice[1]+sheet.data.usedDice[2]:0,fourDice:sheet.data.usedDice.length>=4?sheet.data.usedDice[0]+sheet.data.usedDice[1]+sheet.data.usedDice[2]+sheet.data.usedDice[3]:0,fiveDice:sheet.data.usedDice.length>=5?sheet.data.usedDice[0]+sheet.data.usedDice[1]+sheet.data.usedDice[2]+sheet.data.usedDice[3]+sheet.data.usedDice[4]:0};jQ("#diceNum_2").text(e.twoDice);jQ("#diceNum_3").text(e.threeDice);jQ("#diceNum_4").text(e.fourDice);jQ("#diceNum_5").text(e.fiveDice)},setStunWoundClicks:function(){jQ(document).find(".characterInfo .btnUpDown").click(function(){var e=jQ(this);switch(e.attr("id")){case"woundPointsUp":e.siblings("input[type=text]").val(sheet.data.characterInfo.woundPoints+=1);break;case"woundPointsDown":e.siblings("input[type=text]").val(sheet.data.characterInfo.woundPoints-=1);break;case"stunPointsUp":e.siblings("input[type=text]").val(sheet.data.characterInfo.stunPoints+=1);break;case"stunPointsDown":e.siblings("input[type=text]").val(sheet.data.characterInfo.stunPoints-=1);break}sheet.functions.saveQueue("characterInfo");sheet.functions.ouchCheck()})},ouchCheck:function(){var e=sheet.data.characterInfo.woundPoints+sheet.data.characterInfo.stunPoints,t=100/sheet.data.derivedTraits.lifePoints*sheet.data.characterInfo.woundPoints,n=100/sheet.data.derivedTraits.lifePoints*sheet.data.characterInfo.stunPoints,r=100/sheet.data.derivedTraits.lifePoints*e/100,i=100-t,s=100-n;sheet.settings.woundBarObj.animate({width:t+"%"}).css("backgroundColor","rgba(255,0,0,"+r+")");sheet.settings.stunBarObj.animate({width:n+"%"}).css("backgroundColor","rgba(255,0,255,"+r+")");sheet.settings.woundCounterBarObj.animate({width:i+"%"});sheet.settings.stunCounterBarObj.animate({width:s+"%"});if(sheet.data.characterInfo.woundPoints>0){jQ("#woundPointsDown").removeClass("hide")}if(sheet.data.characterInfo.woundPoints===0){jQ("#woundPointsDown").addClass("hide")}if(sheet.data.characterInfo.stunPoints>0){jQ("#stunPointsDown").removeClass("hide")}if(sheet.data.characterInfo.stunPoints===0){jQ("#stunPointsDown").addClass("hide")}if(sheet.data.characterInfo.woundPoints+sheet.data.characterInfo.stunPoints>=sheet.data.derivedTraits.lifePoints){jQ("#woundPointsUp, #stunPointsUp").addClass("hide")}if(sheet.data.characterInfo.woundPoints+sheet.data.characterInfo.stunPoints<sheet.data.derivedTraits.lifePoints){jQ("#woundPointsUp, #stunPointsUp").removeClass("hide")}sheet.functions.deathCheck()},deathCheck:function(){if(sheet.data.derivedTraits.lifePoints<=sheet.data.characterInfo.woundPoints+sheet.data.characterInfo.stunPoints){sheet.functions.popup("You DEAD!!","dead")}},setDerivedTraits:function(){jQ("#agl, #alert, #vit, #willpower").blur(function(){sheet.functions.getDerivedTraits(jQ(this))})},skillCountChanger:function(){jQ(document).find(".skillsSpecialties .btnUpDown").click(function(){var e=jQ(this),t=jQ("#SkillsCnt"),n=parseInt(t.text());switch(e.attr("id")){case"skillUp":jQ.ajax({url:sheet.settings.newSkillUrl,type:"POST",data:{data:n,used:sheet.data.usedSkills},dataType:"html",success:function(e){jQ("#skillsContainer").append(e).find(".column:last-child").slideDown("fast");if(sheet.functions.getSkills()){sheet.data.hasChanged=false;sheet.functions.saveQueue("skills")}},error:function(e,t,n){sheet.functions.ajaxError(n)}});n+=1;t.text(n);if(n>0){jQ("#skillDown").removeClass("hide")}break;case"skillDown":jQ("#skillsContainer").find(".column:last-child").slideUp("fast",function(){jQ(this).remove();n-=1;sheet.data.usedSkills.pop();delete sheet.data.skills["skill_"+n];delete sheet.data.skills["field_"+n+"_0"];delete sheet.data.skills["field_"+n+"_1"];delete sheet.data.skills["field_"+n+"_2"];delete sheet.data.skills["field_"+n+"_3"];delete sheet.data.skills["field_"+n+"_4"];delete sheet.data.skills["field_"+n+"_5"];delete sheet.data.skills["field_"+n+"_6"];if(n>0){jQ("#skillsContainer").find("input:first-child").trigger("blur")}sheet.functions.getSkills();sheet.functions.saveQueue("skills");t.text(n);if(n===0){jQ("#skillDown").addClass("hide")}});break}})},skillUpdater:function(){jQ("#skillsContainer").on("change",".skilColum_1 select",function(){var e=jQ(this),t=e.attr("id"),n=e.val(),r={};n=n.replace(/[ ]/gi,"_");n=n.replace(/\.|\*/gi,"");if(sheet.functions.getSkills()){for(skills in sheet.data.allskills){if(n===skills){for(var i=0;i<sheet.data.allskills[skills].length;i+=1){var s=sheet.data.allskills[skills];for(var o=0;o<s.length;o+=1){r[s[o].toLowerCase()]=s[o]}}}}jQ("#"+t+"_1 option:gt(0)").remove();jQ("#"+t+"_2 option:gt(0)").remove();jQ("#"+t+"_3 option:gt(0)").remove();jQ.each(r,function(e,n){jQ("#"+t+"_1").append(jQ("<option></option>").attr("value",e).text(n));jQ("#"+t+"_2").append(jQ("<option></option>").attr("value",e).text(n));jQ("#"+t+"_3").append(jQ("<option></option>").attr("value",e).text(n))});jQ("#skillsContainer").find(".skilColum_1 option").each(function(){jQ(this).removeAttr("disabled");for(var e in sheet.data.usedSkills){if(sheet.data.usedSkills[e]===jQ(this).val()){jQ(this).attr("disabled","disabled")}}});sheet.functions.getSpecialChanges.skill()}})},subSkillUpdater:function(){jQ("#skillsContainer").on("change",".skilColum_2 select",function(){var e=jQ(this),t=jQ("#skillsContainer .skilColum_2 option"),n=0;sheet.data.usedSubSkills=[];jQ("#skillsContainer").find(".skilColum_2 select").each(function(){var e=jQ(this);if(e.attr("name").indexOf("f")===0&&isNaN(e.val())){sheet.data.usedSubSkills[n]=e.val();n+=1}});t.each(function(){jQ(this).removeAttr("disabled")});t.each(function(){for(var e in sheet.data.usedSubSkills){if(sheet.data.usedSubSkills[e]===jQ(this).val()){jQ(this).attr("disabled","disabled")}}});sheet.functions.getSpecialChanges.skill()})},setEquipmentTabs:function(){jQ(document).find(".equipTab").click(function(){var e=jQ(this),t=e.children("label").attr("for");jQ(document).find(".equipTab").each(function(){if(jQ(this).hasClass("active")){jQ(this).removeClass("active")}});e.addClass("active");sheet.data.equipment.activeTab=t;sheet.functions.setEquipmentFields(t);sheet.data.hasChanged=false;sheet.functions.saveQueue("equipment")})},setEquipmentResizer:function(){jQ(document).find(".expandContract").click(function(){jQ(this).toggleClass("active");jQ(document).find(".equipInput textarea").each(function(){jQ(this).animate({height:sheet.data.equipResize},500)});sheet.data.equipResize=sheet.data.equipResize==="+=300"?"-=300":"+=300"})},setEquipmentFields:function(e){jQ(document).find(".equipInput textarea").each(function(){var t=jQ(this);if(t.hasClass("active")){t.removeClass("active")}if(t.attr("id")===e){t.addClass("active")}})},updateAllItemsField:function(){var e={};jQ(document).find(".equipInput textarea").each(function(){e[jQ(this).attr("id")]=jQ(this).val()});delete e.allitems;delete e.notes;sheet.data.allItems="";for(var t in e){sheet.data.allItems+=t.charAt(0).toUpperCase()+t.slice(1)+":\n"+e[t]+"\n\n\n"}jQ("#allitems").val(sheet.data.allItems)},compCountChanger:function(){jQ("#complicationsUp, #complicationsDown").on("click",function(){var e=jQ(this),t=jQ("#complicationsCnt"),n=parseInt(t.text());switch(e.attr("id")){case"complicationsUp":jQ.ajax({url:sheet.settings.newCompAssetUrl,type:"POST",data:{count:n,type:"complications",used:sheet.data.usedComp},dataType:"html",success:function(e){jQ("#complicationsFields").append(e).find(".section:last-child").slideDown("fast");if(sheet.functions.getComplications()){sheet.data.hasChanged=false;sheet.functions.saveQueue("comp")}},error:function(e,t,n){sheet.functions.ajaxError(n)}});n+=1;t.text(n);if(n>0){jQ("#complicationsDown").removeClass("hide")}break;case"complicationsDown":jQ("#complicationsFields").find(".section:last-child").slideUp("fast",function(){jQ(this).remove();n-=1;sheet.data.usedComp.pop();delete sheet.data.comp["desc_"+n+"_complications"];delete sheet.data.comp["maj_"+n+"_complications"];delete sheet.data.comp["min_"+n+"_complications"];delete sheet.data.comp["typeName_"+n+"_complications"];sheet.functions.getComplications();sheet.functions.saveQueue("comp");t.text(n);if(n===0){e.addClass("hide")}});break}})},compUpdater:function(){jQ("#complicationsFields").on("change","select, input",function(){sheet.functions.getSpecialChanges.comp()});jQ("#complicationsFields").on("focus","textarea",function(){var e=jQ(this);if(e.val()==="(NOTES)"){e.removeClass("new").val("")}});jQ("#complicationsFields").on("blur","textarea",function(){var e=jQ(this);if(e.val()===""){e.addClass("new").val("(NOTES)")}sheet.functions.getSpecialChanges.comp()});jQ("#complicationsFields").on("change","select",function(){jQ("#complicationsFields").find("option").each(function(){jQ(this).removeAttr("disabled");for(var e in sheet.data.usedComp){if(sheet.data.usedComp[e]===jQ(this).val()){jQ(this).attr("disabled","disabled")}}})})},assetCountChanger:function(){jQ("#assetsUp, #assetsDown").on("click",function(){var e=jQ(this),t=jQ("#assetsCnt"),n=parseInt(t.text());switch(e.attr("id")){case"assetsUp":jQ.ajax({url:sheet.settings.newCompAssetUrl,type:"POST",data:{count:n,type:"assets",used:sheet.data.usedAsset},dataType:"html",success:function(e){jQ("#assetsFields").append(e).find(".section:last-child").slideDown("fast");if(sheet.functions.getAssets()){sheet.data.hasChanged=false;sheet.functions.saveQueue("asset")}},error:function(e,t,n){sheet.functions.ajaxError(n)}});n+=1;t.text(n);if(n>0){jQ("#assetsDown").removeClass("hide")}break;case"assetsDown":jQ("#assetsFields").find(".section:last-child").slideUp("fast",function(){jQ(this).remove();n-=1;sheet.data.usedAsset.pop();delete sheet.data.asset["desc_"+n+"_assets"];delete sheet.data.asset["maj_"+n+"_assets"];delete sheet.data.asset["min_"+n+"_assets"];delete sheet.data.asset["typeName_"+n+"_assets"];sheet.functions.getAssets();sheet.functions.saveQueue("asset");t.text(n);if(n===0){e.addClass("hide")}});break}})},assetUpdater:function(){jQ("#assetsFields").on("change","select, input",function(){sheet.functions.getSpecialChanges.asset()});jQ("#assetsFields").on("focus","textarea",function(){var e=jQ(this);if(e.val()==="(NOTES)"){e.removeClass("new").val("")}});jQ("#assetsFields").on("blur","textarea",function(){var e=jQ(this);if(e.val()===""){e.addClass("new").val("(NOTES)")}sheet.functions.getSpecialChanges.asset()});jQ("#assetsFields").on("change","select",function(){jQ("#assetsFields").find("option").each(function(){jQ(this).removeAttr("disabled");for(var e in sheet.data.usedAsset){if(sheet.data.usedAsset[e]!=="========"&&sheet.data.usedAsset[e]===jQ(this).val()){jQ(this).attr("disabled","disabled")}}})})},checkInputs:{generic:function(e,t,n){var r=0;if(e.val()===""){e.val(0)}if(e.val()%2||isNaN(e.val())){sheet.functions.popup("The number needs to corispond to a dice number<br /><br />Meaning it needs to be even.");if(typeof e!=="undefined"){e.select();e.focus()}return false}t.each(function(){r+=parseInt(jQ(this).val())});sheet.data.defaultPoints["used"+n+"Points"]=r;sheet.settings["used"+n+"PointsObj"].val(r);if(r>sheet.data.defaultPoints["max"+n+"Points"]){sheet.functions.popup("You have use to many points<br /><br />You only have "+sheet.data.defaultPoints["max"+n+"Points"]+" points to use.<br /><br />And you have used "+r+" so far.");if(typeof e!=="undefined"){e.select();e.focus()}return false}}},setDiceClicks:function(){jQ(document).find(".diceUI li span").click(function(){var e=jQ(this);if(e.data("dice")===0){sheet.data.usedDice=[];sheet.data.dice={};for(var t in sheet.data.displayDice){jQ("#dice_"+t).addClass("hide").val("").data("roll","")}sheet.data.displayDice=[]}else{var n=sheet.functions.getDiceRoll(e.data("dice"));sheet.data.displayDice.unshift("D"+e.data("dice")+" = "+n);while(sheet.data.displayDice.length>14){sheet.data.displayDice.pop()}for(var t in sheet.data.displayDice){var r=jQ("#dice_"+t);sheet.data.dice["dice_"+t]=sheet.data.displayDice[t];r.val(sheet.data.displayDice[t]);if(sheet.data.displayDice[t].length>0&&r.hasClass("hide")){r.removeClass("hide")}}}sheet.functions.getLastRolls();sheet.functions.saveQueue("dice")})},getChanges:function(){jQ(document).find(".characterInfo input[type=text]").blur(function(){if(sheet.functions.getCharacterInfo()){sheet.data.hasChanged=false;sheet.functions.ouchCheck();sheet.functions.save("characterInfo")}});jQ(document).find(".attributes input[type=text]").blur(function(){if(sheet.functions.getAttributes()){sheet.data.hasChanged=false;sheet.functions.save("attributes")}});jQ(document).find(".attributes input[type!=hidden]").blur(function(){sheet.functions.checkInputs.generic(jQ(this),jQ(document).find(".attributes input"),"Attr")});jQ("#skillsContainer").on("blur","input",function(){sheet.functions.checkInputs.generic(jQ(this),jQ("#skillsContainer").find("input"),"Skill")});jQ("#curntInt, #curntEndur, #curntResist").blur(function(){if(sheet.functions.getRolledTraits()){sheet.data.hasChanged=false;sheet.functions.save("rolledTraits")}});jQ("#skillsContainer").on("blur","input[type=text]",function(){if(sheet.functions.getSkills()){sheet.data.hasChanged=false;sheet.functions.save("skills")}});jQ(document).find(".equipInput textarea").blur(function(){if(jQ(this).attr("id")!=="allitems"){sheet.functions.updateAllItemsField();if(sheet.functions.getEquipment()){sheet.data.hasChanged=false;sheet.functions.save("equipment")}}});jQ(document).find(".diceUI span").click(function(){if(sheet.functions.getDice()){sheet.data.hasChanged=false}})},getSpecialChanges:{skill:function(){if(sheet.functions.getSkills()){sheet.data.hasChanged=false;sheet.functions.save("skills")}},comp:function(){if(sheet.functions.getComplications()){sheet.data.hasChanged=false;sheet.functions.save("comp")}},asset:function(){if(sheet.functions.getAssets()){sheet.data.hasChanged=false;sheet.functions.save("asset")}}},saveQueue:function(e){if(sheet.settings.queueTimer===null){sheet.data.saveArea=e;sheet.settings.queueTimer=setTimeout("sheet.functions.save(); sheet.settings.queueTimer = null;",3*1e3)}},save:function(e){e=e||sheet.data.saveArea;jQ.ajax({url:sheet.settings.saveUrl,type:"POST",data:{data:{content:JSON.stringify(sheet.data[e]),saveArea:e}},dataType:"jsonp",jsonpCallback:e+"_callback",success:function(e){if(e.status!=="done"){sheet.settings.saveObj.text(e.status)}else{sheet.settings.saveObj.text("Saved")}sheet.settings.saveObj.animate({top:"+=50"},500).delay(1e3).animate({top:"-=50"},500)},error:function(e,t,n){sheet.functions.ajaxError(n)}})},ajaxError:function(e){var t="<div class='ajaxError'>"+e+"</div>";jQ("body").append(t)},showHideModules:function(){jQ(document).find(".close").on("click",function(){var e=jQ(document).find("."+jQ(this).parent().attr("id"));jQ(this).toggleClass("active");if(e.css("display")==="none"){e.slideDown()}else{e.slideUp()}})},controlsNumbers:function(){jQ("#controlsContainer").click(function(){jQ(this).animate({top:"-300px"},700,function(){jQ("#controlTab").animate({top:"0px"},100)})});jQ("#controlTab").click(function(){jQ(this).animate({top:"-30px"},100,function(){jQ("#controlsContainer").animate({top:"0px"},700)})});jQ("#controlsContainer").delay(5e3).trigger("click")},popup:function(e,t){t=t||"";if(jQ("#bgOverlay").length===0){var n='<div id="bgOverlay" class="bgOverlay"></div>'+'<div id="popUp" class="popUp"></div>';jQ("body").append(n)}switch(t){case"dead":jQ("#bgOverlay").addClass("deathOverlay");break;default:jQ("#bgOverlay").removeClass("deathOverlay")}jQ("#bgOverlay, #popUp").show();jQ("#popUp").html(e).css({top:"20%",left:jQ(window).width()/2-jQ("#popUp").width()/2+"px"});jQ("#bgOverlay").on("click",function(){jQ("#bgOverlay, #popUp").hide()});jQ(document).keyup(function(e){if(e.keyCode===27||e.keyCode===13){jQ("#bgOverlay, #popUp").hide()}})},unLoad:function(){sheet.functions.getCharacterInfo();sheet.functions.getAttributes();sheet.functions.getDerivedTraits();sheet.functions.getRolledTraits();sheet.functions.getSkills();sheet.functions.getEquipment();sheet.functions.getComplications();sheet.functions.getAssets();sheet.functions.getDice();jQ.ajax({url:sheet.settings.saveUrl,type:"POST",data:{data:{content:JSON.stringify(sheet.data),saveArea:"all"}},async:false})},signOut:function(){jQ(document).find(".signOut").click(function(e){e.preventBubble();window.location=jQ(this).attr("href")})}}};jQ(document).ready(function(){sheet.functions.init()});jQ(window).unload(function(){})